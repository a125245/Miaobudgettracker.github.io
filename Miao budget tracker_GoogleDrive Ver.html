<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶æ”¯ç®¡ç†è¡¨ - Google Drive ç‰ˆ</title>
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        h1 {
            color: #4472C4;
            font-size: 28px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .view-toggle {
            display: flex;
            gap: 10px;
        }
        
        .view-btn {
            background: #e8f0ff;
            color: #4472C4;
            border: 2px solid #4472C4;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: #4472C4;
            color: white;
        }
        
        .view-btn:hover {
            background: #4472C4;
            color: white;
        }
        
        .month-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .month-selector select {
            padding: 10px;
            border: 2px solid #4472C4;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            color: #4472C4;
            background: white;
        }
        
        .export-btn, .backup-btn {
            background: #4472C4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .export-btn:hover, .backup-btn:hover {
            background: #365a9b;
        }
        
        .backup-btn {
            background: #FFC107;
            color: #333;
        }
        
        .backup-btn:hover {
            background: #FFB300;
        }
        
        .data-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .data-status.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .summary-card.income {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .summary-card.expense {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .summary-card.balance {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .summary-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .summary-card .amount {
            font-size: 32px;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
        }
        
        .section-title {
            color: #4472C4;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4472C4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .add-category-btn {
            background: #FFC107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        
        .add-category-btn:hover {
            background: #FFB300;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th {
            background: #4472C4;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #ddd;
        }
        
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .stats-section {
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        
        .stat-title {
            color: #4472C4;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .stat-table {
            width: 100%;
        }
        
        .stat-table th {
            background: #4472C4;
            padding: 8px;
            font-size: 14px;
        }
        
        .stat-table td {
            padding: 8px;
            font-size: 14px;
        }
        
        .total-row {
            font-weight: bold;
            background: #e8f0ff !important;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
        }
        
        .chart-title {
            color: #4472C4;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .add-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            width: 100%;
        }
        
        .add-btn:hover {
            background: #218838;
        }
        
        input[type="date"], input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr 1.2fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            color: #4472C4;
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .modal-btn.primary {
            background: #4472C4;
            color: white;
        }
        
        .modal-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        #yearView {
            display: none;
        }
        
        .year-months-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .month-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .month-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .month-card h4 {
            color: #4472C4;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .month-stats {
            font-size: 14px;
        }
        
        .month-stats div {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .month-stats .label {
            color: #666;
        }
        
        .month-stats .value {
            font-weight: bold;
        }
        
        .month-stats .value.positive {
            color: #28a745;
        }
        
        .month-stats .value.negative {
            color: #dc3545;
        }
        
        .backup-section {
            margin: 20px 0;
        }
        
        .backup-section h3 {
            color: #4472C4;
            margin-bottom: 10px;
        }
        
        .backup-section button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ’° æ”¶æ”¯ç®¡ç†è¡¨ 
                    <span class="status-badge" id="driveBadge">ğŸ”„ å°šæœªç™»å…¥</span>
                </h1>
            </div>
            <div class="header-controls">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('month', this)">æœˆåº¦æª¢è¦–</button>
                    <button class="view-btn" onclick="switchView('year', this)">å¹´åº¦æª¢è¦–</button>
                </div>
                <div class="month-selector" id="monthSelector">
                    <select id="yearSelect" onchange="changeMonth()">
                        <option value="2026">2026å¹´</option>
                        <option value="2025">2025å¹´</option>
                        <option value="2024">2024å¹´</option>
                        <option value="2023">2023å¹´</option>
                    </select>
                    <select id="monthSelect" onchange="changeMonth()">
                        <option value="1">1æœˆ</option>
                        <option value="2" selected>2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>
                <button class="backup-btn" id="driveLoginBtn" onclick="handleAuthClick()">ğŸ” ç™»å…¥ Google</button>
                <button class="backup-btn" id="driveSyncBtn" onclick="loadFromDrive()" style="display:none">ğŸ”„ å¾é›²ç«¯è¼‰å…¥</button>
                <button class="backup-btn" onclick="openBackupModal()">ğŸ’¾ å‚™ä»½/é‚„åŸ</button>
                <button class="export-btn" onclick="exportToExcel()">ğŸ“¥ å°å‡ºExcel</button>
            </div>
        </div>
        
        <!-- æœˆåº¦æª¢è¦– -->
        <div id="monthView">
            <div class="summary-cards">
                <div class="summary-card income">
                    <h3>ğŸ’° æœ¬æœˆæ”¶å…¥</h3>
                    <div class="amount" id="monthIncome">$0</div>
                </div>
                <div class="summary-card expense">
                    <h3>ğŸ’¸ æœ¬æœˆæ”¯å‡º</h3>
                    <div class="amount" id="monthExpense">$0</div>
                </div>
                <div class="summary-card balance">
                    <h3>ğŸ’µ æœ¬æœˆé¤˜é¡</h3>
                    <div class="amount" id="monthBalance">$0</div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="section">
                    <div class="section-title">
                        <span>æ”¶å…¥</span>
                        <button class="add-category-btn" onclick="openAddCategoryModal('income')">â• æ–°å¢é¡åˆ¥</button>
                    </div>
                    <table id="incomeTable">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>é‡‘é¡</th>
                                <th>é¡åˆ¥</th>
                                <th>å‚™è¨»</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="input-row">
                        <input type="date" id="incomeDate" value="2026-02-16">
                        <input type="number" id="incomeAmount" placeholder="é‡‘é¡">
                        <select id="incomeCategory"></select>
                        <input type="text" id="incomeNote" placeholder="å‚™è¨»">
                    </div>
                    <button class="add-btn" onclick="addIncome()">â• æ–°å¢æ”¶å…¥</button>
                </div>
                
                <div class="section">
                    <div class="section-title">
                        <span>æ”¯å‡º</span>
                        <button class="add-category-btn" onclick="openAddCategoryModal('expense')">â• æ–°å¢é¡åˆ¥</button>
                    </div>
                    <table id="expenseTable">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>é‡‘é¡</th>
                                <th>é¡åˆ¥</th>
                                <th>å‚™è¨»</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="input-row">
                        <input type="date" id="expenseDate" value="2026-02-16">
                        <input type="number" id="expenseAmount" placeholder="é‡‘é¡">
                        <select id="expenseCategory"></select>
                        <input type="text" id="expenseNote" placeholder="å‚™è¨»">
                    </div>
                    <button class="add-btn" onclick="addExpense()">â• æ–°å¢æ”¯å‡º</button>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š æœ¬æœˆæ”¶å…¥åˆ†æ</div>
                    <canvas id="incomeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š æœ¬æœˆæ”¯å‡ºåˆ†æ</div>
                    <canvas id="expenseChart"></canvas>
                </div>
            </div>
            
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">æ”¶æ”¯ç¸½è¨ˆ</div>
                        <table class="stat-table">
                            <thead>
                                <tr>
                                    <th>é¡åˆ¥</th>
                                    <th>åˆè¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody id="summaryStats"></tbody>
                        </table>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-title">æ”¶å…¥çµ±è¨ˆ</div>
                        <table class="stat-table">
                            <thead>
                                <tr>
                                    <th>é¡åˆ¥</th>
                                    <th>åˆè¨ˆ</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody id="incomeStats"></tbody>
                        </table>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-title">æ”¯å‡ºçµ±è¨ˆ</div>
                        <table class="stat-table">
                            <thead>
                                <tr>
                                    <th>é¡åˆ¥</th>
                                    <th>åˆè¨ˆ</th>
                                    <th>%</th>
                                </tr>
                            </thead>
                            <tbody id="expenseStats"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å¹´åº¦æª¢è¦– -->
        <div id="yearView">
            <div class="summary-cards">
                <div class="summary-card income">
                    <h3>ğŸ’° å¹´åº¦ç¸½æ”¶å…¥</h3>
                    <div class="amount" id="yearIncome">$0</div>
                </div>
                <div class="summary-card expense">
                    <h3>ğŸ’¸ å¹´åº¦ç¸½æ”¯å‡º</h3>
                    <div class="amount" id="yearExpense">$0</div>
                </div>
                <div class="summary-card balance">
                    <h3>ğŸ’µ å¹´åº¦é¤˜é¡</h3>
                    <div class="amount" id="yearBalance">$0</div>
                </div>
            </div>
            
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š å¹´åº¦æ”¶å…¥åˆ†æ</div>
                    <canvas id="yearIncomeChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">ğŸ“Š å¹´åº¦æ”¯å‡ºåˆ†æ</div>
                    <canvas id="yearExpenseChart"></canvas>
                </div>
            </div>
            
            <div class="stats-section">
                <h2 class="stat-title">å„æœˆä»½æ˜ç´°</h2>
                <div class="year-months-grid" id="yearMonthsGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- æ–°å¢é¡åˆ¥Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢é¡åˆ¥</div>
            <input type="text" id="newCategoryInput" class="modal-input" placeholder="è¼¸å…¥æ–°é¡åˆ¥åç¨±ï¼ˆå¦‚ï¼šğŸ¬ é›»å½±ï¼‰">
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn primary" onclick="addNewCategory()">ç¢ºå®š</button>
            </div>
        </div>
    </div>
    
    <!-- å‚™ä»½/é‚„åŸModal -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</div>
            
            <div class="backup-section">
                <h3>ğŸ“¥ ä¸‹è¼‰å‚™ä»½</h3>
                <p style="color: #666; margin-bottom: 10px; font-size: 14px;">å°‡æ‰€æœ‰è³‡æ–™ä¸‹è¼‰ç‚º JSON æª”æ¡ˆ</p>
                <button class="modal-btn primary" onclick="downloadBackup()">ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</button>
            </div>
            
            <div class="backup-section">
                <h3>ğŸ“¤ é‚„åŸå‚™ä»½</h3>
                <p style="color: #666; margin-bottom: 10px; font-size: 14px;">å¾ä¹‹å‰ä¸‹è¼‰çš„å‚™ä»½æª”æ¡ˆé‚„åŸè³‡æ–™</p>
                <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px;">
                <button class="modal-btn primary" onclick="restoreBackup()">é‚„åŸè³‡æ–™</button>
            </div>
            
            <div class="backup-section">
                <h3 style="color: #dc3545;">âš ï¸ æ¸…ç©ºè³‡æ–™</h3>
                <p style="color: #666; margin-bottom: 10px; font-size: 14px;">åˆªé™¤æ‰€æœ‰è¨˜éŒ„ï¼ˆç„¡æ³•å¾©åŸï¼‰</p>
                <button class="modal-btn danger" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
            </div>
            
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn secondary" onclick="closeBackupModal()">é—œé–‰</button>
            </div>
        </div>
    </div>
    
    <!-- æ•¸æ“šç‹€æ…‹æç¤º -->
    <div id="dataStatus" class="data-status"></div>
    
    <script>
        // =============================================
        // âš ï¸  è«‹å¡«å…¥ä½ çš„ Google Cloud è¨­å®š
        // =============================================
        const GOOGLE_CLIENT_ID  = '22224752656-7vhjf93bnntp3kpb0ine0ooi2tqjrf4j.apps.googleusercontent.com';
        const GOOGLE_API_KEY    = 'AIzaSyDaLz__2G-ZpErwwmnC_qTzxIQqPcmiVsQ';
        const DRIVE_FOLDER_NAME = 'å¦™å¦™è¡Œæ”¿/æ”¶æ”¯ç®¡ç†è¡¨';       // Drive è£¡çš„è³‡æ–™å¤¾åç¨±
        const JSON_FILENAME     = 'budget-data.json'; // è³‡æ–™æª”å

        // =============================================
        // å¸¸æ•¸ & å…¨åŸŸè®Šæ•¸
        // =============================================
        const LOCAL_STORAGE_KEY  = 'budgetTrackerData';
        const CATEGORIES_KEY     = 'budgetTrackerCategories';
        const DRIVE_FILE_ID_KEY  = 'budgetDriveFileId';   // å¿«å– file id

        const DEFAULT_INCOME_CATEGORIES  = ['ğŸ’° é›¶ç”¨é‡‘å…¥å¸³','ğŸ’µ åˆ©æ¯','ğŸ çé‡‘','ğŸ›  è‚¡ç¥¨','ğŸ  å…¶ä»–'];
        const DEFAULT_EXPENSE_CATEGORIES = ['ğŸ¥— é›œè²¨','ğŸ” é£²æ–™','ğŸš— å¨›æ¨‚','ğŸ  ä½æˆ¿','ğŸ”§ äº¤é€š','ğŸ’Š é†«ç™‚','ğŸ‘• æœé£¾','ğŸ“ æ•™è‚²','ğŸ“± é€šè¨Š','ğŸ® ä¼‘é–’','ğŸ¥ ä¿éšª','ğŸ äººæƒ…','ğŸ”§ ç¶­ä¿®','ğŸ¦ ç¨…é‡‘'];

        let database = {
            incomes: [], expenses: [],
            incomeCategories:  [...DEFAULT_INCOME_CATEGORIES],
            expenseCategories: [...DEFAULT_EXPENSE_CATEGORIES]
        };

        let incomeChart, expenseChart, yearIncomeChart, yearExpenseChart;
        let currentView  = 'month';
        let currentYear  = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let categoryModalType = '';

        // Google ç™»å…¥ç‹€æ…‹
        let tokenClient  = null;
        let accessToken  = null;
        let driveFileId  = localStorage.getItem(DRIVE_FILE_ID_KEY) || null;

        // =============================================
        // Google OAuth 2.0 åˆå§‹åŒ–
        // =============================================
        function initGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: async (resp) => {
                    if (resp.error) {
                        console.error('OAuth éŒ¯èª¤:', resp.error);
                        setBadge('âŒ ç™»å…¥å¤±æ•—', '#dc3545');
                        return;
                    }
                    accessToken = resp.access_token;
                    onSignedIn();
                }
            });
        }

        function handleAuthClick() {
            if (!accessToken) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                // å·²ç™»å…¥ â†’ ç™»å‡º
                google.accounts.oauth2.revoke(accessToken, () => {
                    accessToken = null;
                    setBadge('ğŸ”„ å°šæœªç™»å…¥', '#6c757d');
                    document.getElementById('driveLoginBtn').textContent = 'ğŸ” ç™»å…¥ Google';
                    document.getElementById('driveSyncBtn').style.display = 'none';
                    showStatus('å·²ç™»å‡º Google');
                });
            }
        }

        async function onSignedIn() {
            setBadge('âœ… å·²é€£ç·š Google Drive', '#28a745');
            document.getElementById('driveLoginBtn').textContent = 'ğŸ”“ ç™»å‡º Google';
            document.getElementById('driveSyncBtn').style.display = 'inline-block';
            showStatus('âœ… å·²ç™»å…¥ Googleï¼Œæ­£åœ¨è¼‰å…¥è³‡æ–™...');
            await loadFromDrive();
        }

        // =============================================
        // Google Drive API æ“ä½œ
        // =============================================

        // é€šç”¨ fetch åŒ…è£ï¼ˆè‡ªå‹•å¸¶ tokenï¼‰
        async function driveRequest(url, options = {}) {
            const resp = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    ...options.headers
                }
            });
            if (!resp.ok) {
                const err = await resp.text();
                throw new Error(`Drive API éŒ¯èª¤ ${resp.status}: ${err}`);
            }
            return resp;
        }

        // æ‰¾åˆ°æˆ–å»ºç«‹ Drive è³‡æ–™å¤¾ï¼Œå›å‚³ folder id
        async function getOrCreateFolder() {
            // æœå°‹æ˜¯å¦å·²æœ‰åŒåè³‡æ–™å¤¾
            const q = encodeURIComponent(
                `name='${DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`
            );
            const resp = await driveRequest(
                `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name)&supportsAllDrives=true&includeItemsFromAllDrives=true`
            );
            const data = await resp.json();
            if (data.files && data.files.length > 0) {
                return data.files[0].id;  // å·²å­˜åœ¨
            }
            // å»ºç«‹æ–°è³‡æ–™å¤¾
            const createResp = await driveRequest(
                'https://www.googleapis.com/drive/v3/files',
                {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: DRIVE_FOLDER_NAME,
                        mimeType: 'application/vnd.google-apps.folder'
                    })
                }
            );
            const folder = await createResp.json();
            return folder.id;
        }

        // æœå°‹ budget-data.jsonï¼Œå›å‚³ file id æˆ– null
        async function findDataFile(folderId) {
            const q = encodeURIComponent(
                `name='${JSON_FILENAME}' and '${folderId}' in parents and trashed=false`
            );
            const resp = await driveRequest(
                `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)&supportsAllDrives=true&includeItemsFromAllDrives=true`
            );
            const data = await resp.json();
            return (data.files && data.files.length > 0) ? data.files[0] : null;
        }

        // å¾ Drive ä¸‹è¼‰ JSON è³‡æ–™
        async function loadFromDrive() {
            if (!accessToken) { alert('è«‹å…ˆç™»å…¥ Googleï¼'); return; }
            setBadge('ğŸ”„ è¼‰å…¥ä¸­...', '#FFC107');
            try {
                
                const folderId = await getOrCreateFolder();
                const file     = await findDataFile(folderId);

                if (!file) {
                    // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œä¸Šå‚³ç•¶å‰è³‡æ–™
                    setBadge('â˜ï¸ å·²é€£ç·šï¼ˆæ–°å»ºæª”æ¡ˆï¼‰', '#28a745');
                    showStatus('ğŸ“ Drive ç„¡è³‡æ–™ï¼Œä¸Šå‚³æœ¬åœ°è³‡æ–™ä¸­...');
                    await saveToDrive();
                    return;
                }

                driveFileId = file.id;
                localStorage.setItem(DRIVE_FILE_ID_KEY, driveFileId);

                // ä¸‹è¼‰æª”æ¡ˆå…§å®¹
                const dlResp = await driveRequest(
                    `https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`
                );
                const parsed = await dlResp.json();

                database.incomes            = parsed.incomes            || [];
                database.expenses           = parsed.expenses           || [];
                database.incomeCategories   = parsed.incomeCategories   || DEFAULT_INCOME_CATEGORIES;
                database.expenseCategories  = parsed.expenseCategories  || DEFAULT_EXPENSE_CATEGORIES;

                saveToLocal();
                updateCategorySelects();
                updateMonthView();
                setBadge('â˜ï¸ Google Drive å·²åŒæ­¥', '#28a745');
                showStatus('âœ… å·²å¾ Google Drive è¼‰å…¥ï¼ˆæ›´æ–°ï¼š' + new Date(file.modifiedTime).toLocaleString() + 'ï¼‰');

            } catch(e) {
                console.error('Drive è¼‰å…¥å¤±æ•—', e);
                setBadge('âš ï¸ è¼‰å…¥å¤±æ•—', '#dc3545');
                showStatus('âŒ ç„¡æ³•å¾ Drive è¼‰å…¥ï¼š' + e.message, 'error');
            }
        }

        // ä¸Šå‚³ / æ›´æ–° JSON åˆ° Drive
        async function saveToDrive() {
            if (!accessToken) return;   // æœªç™»å…¥éœé»˜è·³é
            setBadge('ğŸ”„ å„²å­˜ä¸­...', '#FFC107');
            try {
                const payload = JSON.stringify({
                    version: '3.0',
                    lastUpdated: new Date().toISOString(),
                    incomes:           database.incomes,
                    expenses:          database.expenses,
                    incomeCategories:  database.incomeCategories,
                    expenseCategories: database.expenseCategories
                }, null, 2);

                if (driveFileId) {
                    // æ›´æ–°ç¾æœ‰æª”æ¡ˆï¼ˆPATCH multipartï¼‰
                    const boundary = 'budget_boundary_' + Date.now();
                    const body = [
                        '--' + boundary,
                        'Content-Type: application/json',
                        '',
                        JSON.stringify({ name: JSON_FILENAME }),
                        '--' + boundary,
                        'Content-Type: application/json',
                        '',
                        payload,
                        '--' + boundary + '--'
                    ].join('\r\n');

                    await driveRequest(
                        `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`,
                        {
                            method: 'PATCH',
                            headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` },
                            body: body
                        }
                    );
                } else {
                    // å»ºç«‹æ–°æª”æ¡ˆ
                    const folderId = await getOrCreateFolder();
                    const boundary = 'budget_boundary_' + Date.now();
                    const metadata = JSON.stringify({
                        name: JSON_FILENAME,
                        parents: [folderId]
                    });
                    const body = [
                        '--' + boundary,
                        'Content-Type: application/json',
                        '',
                        metadata,
                        '--' + boundary,
                        'Content-Type: application/json',
                        '',
                        payload,
                        '--' + boundary + '--'
                    ].join('\r\n');

                    const createResp = await driveRequest(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': `multipart/related; boundary="${boundary}"` },
                            body: body
                        }
                    );
                    const created = await createResp.json();
                    driveFileId = created.id;
                    localStorage.setItem(DRIVE_FILE_ID_KEY, driveFileId);
                }

                setBadge('â˜ï¸ Google Drive å·²åŒæ­¥', '#28a745');

            } catch(e) {
                console.error('Drive å„²å­˜å¤±æ•—', e);
                setBadge('âš ï¸ å„²å­˜å¤±æ•—', '#dc3545');
                showStatus('âŒ ç„¡æ³•å„²å­˜åˆ° Driveï¼š' + e.message, 'error');
            }
        }

        // =============================================
        // æ¯æ¬¡æ›´å‹•ï¼šæœ¬åœ° + Drive åŒæ™‚å„²å­˜
        // =============================================
        async function saveAll() {
            saveToLocal();
            await saveToDrive();
            showStatus('ğŸ’¾ å·²å„²å­˜');
        }

        // =============================================
        // localStorageï¼ˆå¿«å– / é›¢ç·šå‚™æ´ï¼‰
        // =============================================
        function saveToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({
                    incomes: database.incomes, expenses: database.expenses
                }));
                localStorage.setItem(CATEGORIES_KEY, JSON.stringify({
                    income: database.incomeCategories, expense: database.expenseCategories
                }));
            } catch(e) { console.warn('localStorage å¯«å…¥å¤±æ•—', e); }
        }

        function loadFromLocal() {
            try {
                const saved    = localStorage.getItem(LOCAL_STORAGE_KEY);
                const savedCat = localStorage.getItem(CATEGORIES_KEY);
                if (saved) {
                    const p = JSON.parse(saved);
                    database.incomes  = p.incomes  || [];
                    database.expenses = p.expenses || [];
                }
                if (savedCat) {
                    const c = JSON.parse(savedCat);
                    database.incomeCategories  = c.income  || DEFAULT_INCOME_CATEGORIES;
                    database.expenseCategories = c.expense || DEFAULT_EXPENSE_CATEGORIES;
                }
            } catch(e) { console.warn('localStorage è®€å–å¤±æ•—', e); }
        }

        // =============================================
        // ç‹€æ…‹ UI
        // =============================================
        function setBadge(text, color) {
            const b = document.getElementById('driveBadge');
            if (b) { b.textContent = text; b.style.background = color || '#28a745'; }
        }

        function showStatus(message, type = 'success') {
            const el = document.getElementById('dataStatus');
            el.textContent = message;
            el.className   = 'data-status show';
            el.style.background = (type === 'error') ? '#dc3545' : '#28a745';
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // =============================================
        // å‚™ä»½ / é‚„åŸ Modal
        // =============================================
        function openBackupModal()  { document.getElementById('backupModal').style.display = 'block'; }
        function closeBackupModal() { document.getElementById('backupModal').style.display = 'none';  }

        function downloadBackup() {
            const backup = { version:'3.0', timestamp: new Date().toISOString(), data: database };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type:'application/json' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href = url;
            a.download = `æ”¶æ”¯ç®¡ç†å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showStatus('âœ… å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰');
        }

        function restoreBackup() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file) { alert('è«‹é¸æ“‡å‚™ä»½æª”æ¡ˆï¼'); return; }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    const src    = backup.data || backup;
                    if (src.incomes && src.expenses) {
                        if (confirm('ç¢ºå®šè¦é‚„åŸè³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) {
                            database = { ...database, ...src };
                            await saveAll();
                            updateCategorySelects();
                            updateMonthView();
                            showStatus('âœ… è³‡æ–™å·²é‚„åŸä¸¦åŒæ­¥åˆ° Google Drive');
                            closeBackupModal();
                        }
                    } else { alert('å‚™ä»½æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼'); }
                } catch(e) { alert('è®€å–å‚™ä»½æª”æ¡ˆå¤±æ•—ï¼'); }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (!confirm('âš ï¸ æ­¤æ“ä½œå°‡æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ')) return;
            if (!confirm('æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
            database.incomes = []; database.expenses = [];
            database.incomeCategories  = [...DEFAULT_INCOME_CATEGORIES];
            database.expenseCategories = [...DEFAULT_EXPENSE_CATEGORIES];
            await saveAll();
            updateCategorySelects();
            updateMonthView();
            closeBackupModal();
            showStatus('ğŸ—‘ï¸ æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º');
        }

        // =============================================
        // åˆå§‹åŒ–
        // =============================================
        async function initializeApp() {
            document.getElementById('yearSelect').value  = currentYear;
            document.getElementById('monthSelect').value = currentMonth;

            // å…ˆå¾ localStorage å¿«é€Ÿé¡¯ç¤º
            loadFromLocal();
            updateCategorySelects();
            updateMonthView();

            // åˆå§‹åŒ– Google OAuth
            try {
                initGoogleAuth();
                setBadge('ğŸ” è«‹ç™»å…¥ Google', '#FFC107');
            } catch(e) {
                console.error('Google Auth åˆå§‹åŒ–å¤±æ•—', e);
                setBadge('âš ï¸ è«‹ç¢ºèª Client ID è¨­å®š', '#dc3545');
            }
        }

        // =============================================
        // UI å·¥å…·
        // =============================================
        function updateCategorySelects() {
            ['income','expense'].forEach(type => {
                const sel  = document.getElementById(type + 'Category');
                sel.innerHTML = '';
                const cats = type === 'income' ? database.incomeCategories : database.expenseCategories;
                cats.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = cat;
                    sel.appendChild(opt);
                });
            });
        }

        function switchView(view, btn) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            if (view === 'month') {
                document.getElementById('monthView').style.display    = 'block';
                document.getElementById('yearView').style.display     = 'none';
                document.getElementById('monthSelector').style.display = 'flex';
                updateMonthView();
            } else {
                document.getElementById('monthView').style.display    = 'none';
                document.getElementById('yearView').style.display     = 'block';
                document.getElementById('monthSelector').style.display = 'none';
                updateYearView();
            }
        }

        function changeMonth() {
            currentYear  = parseInt(document.getElementById('yearSelect').value);
            currentMonth = parseInt(document.getElementById('monthSelect').value);
            updateMonthView();
        }

        // =============================================
        // æœˆåº¦æª¢è¦–
        // =============================================
        function updateMonthView() {
            const filter = (arr) => arr.filter(item => {
                const d = new Date(item.date);
                return d.getFullYear() === currentYear && d.getMonth()+1 === currentMonth;
            });
            updateTable('incomeTable',  filter(database.incomes));
            updateTable('expenseTable', filter(database.expenses));
            calculateStats();
        }

        function updateTable(tableId, data) {
            const tbody = document.getElementById(tableId).querySelector('tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = item.date;
                const ac = row.insertCell(1);
                ac.textContent = item.amount.toLocaleString(); ac.style.textAlign = 'right';
                row.insertCell(2).textContent = item.category;
                row.insertCell(3).textContent = item.note || '';
                const dc = row.insertCell(4); dc.style.textAlign = 'center';
                const type = tableId === 'incomeTable' ? 'income' : 'expense';
                dc.innerHTML = `<button class="delete-btn" onclick="deleteItem('${type}','${item.id}')">åˆªé™¤</button>`;
            });
        }

        function calculateStats() {
            const calcRows = (sel) => {
                const rows = document.querySelectorAll(sel + ' tbody tr');
                const byCategory = {}; let total = 0;
                rows.forEach(row => {
                    const amount   = parseInt(row.cells[1].textContent.replace(/,/g,''));
                    const category = row.cells[2].textContent;
                    total += amount;
                    byCategory[category] = (byCategory[category] || 0) + amount;
                });
                return { byCategory, total };
            };
            const { byCategory: incCat, total: totalIncome  } = calcRows('#incomeTable');
            const { byCategory: expCat, total: totalExpense } = calcRows('#expenseTable');
            const balance = totalIncome - totalExpense;

            document.getElementById('monthIncome').textContent  = '$' + totalIncome.toLocaleString();
            document.getElementById('monthExpense').textContent = '$' + totalExpense.toLocaleString();
            document.getElementById('monthBalance').textContent = '$' + balance.toLocaleString();

            updateStatsTable('summaryStats', {'ğŸ’° æ”¶å…¥': totalIncome,'ğŸ’¸ æ”¯å‡º': totalExpense,'æœ¬æœˆé¤˜é¡': balance}, false);
            updateStatsTable('incomeStats',  incCat, true, totalIncome);
            updateStatsTable('expenseStats', expCat, true, totalExpense);
            updateCharts(incCat, expCat);
        }

        function updateStatsTable(tableId, data, showPercent, total) {
            const tbody = document.getElementById(tableId); tbody.innerHTML = '';
            for (let [cat, amt] of Object.entries(data)) {
                const row = tbody.insertRow();
                if (cat.includes('é¤˜é¡') || cat.includes('ç¸½è¨ˆ')) row.className = 'total-row';
                row.insertCell(0).textContent = cat;
                const ac = row.insertCell(1); ac.textContent = amt.toLocaleString(); ac.style.textAlign = 'right';
                if (showPercent) {
                    const pc = row.insertCell(2);
                    pc.textContent = total > 0 ? ((amt/total)*100).toFixed(1)+'%' : '0%';
                    pc.style.textAlign = 'right';
                }
            }
            if (showPercent && total > 0) {
                const tr = tbody.insertRow(); tr.className = 'total-row';
                tr.insertCell(0).textContent = tableId.includes('income') ? 'æ”¶å…¥ç¸½è¨ˆ' : 'æ”¯å‡ºç¸½è¨ˆ';
                const ac = tr.insertCell(1); ac.textContent = total.toLocaleString(); ac.style.textAlign = 'right';
                const pc = tr.insertCell(2); pc.textContent = '100%'; pc.style.textAlign = 'right';
            }
        }

        const COLORS_A = ['#4472C4','#70AD47','#FFC000','#FF6B6B','#9966FF','#00B4D8','#FF9F40','#4BC0C0'];
        const COLORS_B = ['#FF6B6B','#4472C4','#70AD47','#FFC000','#9966FF','#00B4D8','#FF9F40','#4BC0C0'];

        function makeChartOpts(getTotal) {
            return {
                responsive: true, maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: ctx => {
                        const v = ctx.parsed || 0, t = getTotal();
                        return ctx.label + ': $' + v.toLocaleString() + ' (' + (t>0?((v/t)*100).toFixed(1):0) + '%)';
                    }}}
                }
            };
        }

        function updateCharts(incomeData, expenseData) {
            const mk = (id, data, colors, ref) => {
                const vals = Object.values(data), total = vals.reduce((a,b)=>a+b,0);
                if (ref) ref.destroy();
                if (total <= 0) return null;
                return new Chart(document.getElementById(id).getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(data), datasets:[{ data: vals, backgroundColor: colors }] },
                    options: makeChartOpts(() => total)
                });
            };
            incomeChart  = mk('incomeChart',  incomeData,  COLORS_A, incomeChart);
            expenseChart = mk('expenseChart', expenseData, COLORS_B, expenseChart);
        }

        // =============================================
        // å¹´åº¦æª¢è¦–
        // =============================================
        function updateYearView() {
            const yi = database.incomes.filter(i  => new Date(i.date).getFullYear() === currentYear);
            const ye = database.expenses.filter(i => new Date(i.date).getFullYear() === currentYear);
            const yiT = yi.reduce((s,i)=>s+i.amount,0);
            const yeT = ye.reduce((s,i)=>s+i.amount,0);
            document.getElementById('yearIncome').textContent  = '$' + yiT.toLocaleString();
            document.getElementById('yearExpense').textContent = '$' + yeT.toLocaleString();
            document.getElementById('yearBalance').textContent = '$' + (yiT-yeT).toLocaleString();

            const byCat = arr => arr.reduce((o,i)=>{ o[i.category]=(o[i.category]||0)+i.amount; return o; },{});
            const yiC = byCat(yi), yeC = byCat(ye);
            const yiCT = Object.values(yiC).reduce((a,b)=>a+b,0);
            const yeCT = Object.values(yeC).reduce((a,b)=>a+b,0);

            if (yearIncomeChart)  yearIncomeChart.destroy();
            if (yearExpenseChart) yearExpenseChart.destroy();
            if (yiCT > 0) yearIncomeChart  = new Chart(document.getElementById('yearIncomeChart').getContext('2d'),
                { type:'doughnut', data:{ labels:Object.keys(yiC), datasets:[{data:Object.values(yiC),backgroundColor:COLORS_A}]}, options:makeChartOpts(()=>yiCT)});
            if (yeCT > 0) yearExpenseChart = new Chart(document.getElementById('yearExpenseChart').getContext('2d'),
                { type:'doughnut', data:{ labels:Object.keys(yeC), datasets:[{data:Object.values(yeC),backgroundColor:COLORS_B}]}, options:makeChartOpts(()=>yeCT)});

            generateMonthCards(yi, ye);
        }

        function generateMonthCards(yi, ye) {
            const grid = document.getElementById('yearMonthsGrid'); grid.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const it = yi.filter(i=>new Date(i.date).getMonth()+1===m).reduce((s,i)=>s+i.amount,0);
                const et = ye.filter(i=>new Date(i.date).getMonth()+1===m).reduce((s,i)=>s+i.amount,0);
                const bal = it - et;
                const card = document.createElement('div'); card.className = 'month-card';
                card.onclick = () => {
                    document.getElementById('monthSelect').value = m;
                    document.querySelectorAll('.view-btn').forEach(b=>b.classList.remove('active'));
                    document.querySelector('.view-btn[onclick*="month"]').classList.add('active');
                    switchView('month', null); changeMonth();
                };
                card.innerHTML = `<h4>${m}æœˆ</h4><div class="month-stats">
                    <div><span class="label">æ”¶å…¥ï¼š</span><span class="value">$${it.toLocaleString()}</span></div>
                    <div><span class="label">æ”¯å‡ºï¼š</span><span class="value">$${et.toLocaleString()}</span></div>
                    <div><span class="label">é¤˜é¡ï¼š</span><span class="value ${bal>=0?'positive':'negative'}">$${bal.toLocaleString()}</span></div>
                </div>`;
                grid.appendChild(card);
            }
        }

        // =============================================
        // è³‡æ–™æ“ä½œ
        // =============================================
        async function addIncome() {
            const date = document.getElementById('incomeDate').value;
            const amt  = document.getElementById('incomeAmount').value;
            if (!date || !amt) { alert('è«‹å¡«å¯«æ—¥æœŸå’Œé‡‘é¡ï¼'); return; }
            database.incomes.push({ id: Date.now().toString(), date, amount: parseInt(amt),
                category: document.getElementById('incomeCategory').value,
                note: document.getElementById('incomeNote').value,
                timestamp: new Date().toISOString() });
            await saveAll();
            document.getElementById('incomeAmount').value = '';
            document.getElementById('incomeNote').value   = '';
            updateMonthView();
        }

        async function addExpense() {
            const date = document.getElementById('expenseDate').value;
            const amt  = document.getElementById('expenseAmount').value;
            if (!date || !amt) { alert('è«‹å¡«å¯«æ—¥æœŸå’Œé‡‘é¡ï¼'); return; }
            database.expenses.push({ id: Date.now().toString(), date, amount: parseInt(amt),
                category: document.getElementById('expenseCategory').value,
                note: document.getElementById('expenseNote').value,
                timestamp: new Date().toISOString() });
            await saveAll();
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNote').value   = '';
            updateMonthView();
        }

        async function deleteItem(type, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            if (type === 'income') database.incomes  = database.incomes.filter(i=>i.id!==id);
            else                   database.expenses = database.expenses.filter(i=>i.id!==id);
            await saveAll();
            updateMonthView();
        }

        // =============================================
        // é¡åˆ¥ç®¡ç†
        // =============================================
        function openAddCategoryModal(type) {
            categoryModalType = type;
            document.getElementById('categoryModal').style.display = 'block';
            document.getElementById('newCategoryInput').value = '';
        }
        function closeModal() { document.getElementById('categoryModal').style.display = 'none'; }

        async function addNewCategory() {
            const cat = document.getElementById('newCategoryInput').value.trim();
            if (!cat) { alert('è«‹è¼¸å…¥é¡åˆ¥åç¨±ï¼'); return; }
            const arr = categoryModalType === 'income' ? database.incomeCategories : database.expenseCategories;
            if (arr.includes(cat)) { alert('æ­¤é¡åˆ¥å·²å­˜åœ¨ï¼'); return; }
            arr.push(cat);
            await saveAll();
            updateCategorySelects();
            closeModal();
            showStatus('âœ… é¡åˆ¥å·²æ–°å¢');
        }

        // =============================================
        // Excel å°å‡º
        // =============================================
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const ws1 = [['æ”¶å…¥'],['æ—¥æœŸ','é‡‘é¡','é¡åˆ¥','å‚™è¨»']];
            database.incomes.forEach(i  => ws1.push([i.date, i.amount, i.category, i.note||'']));
            ws1.push([],['æ”¯å‡º'],['æ—¥æœŸ','é‡‘é¡','é¡åˆ¥','å‚™è¨»']);
            database.expenses.forEach(i => ws1.push([i.date, i.amount, i.category, i.note||'']));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws1), 'æ”¶æ”¯è¨˜éŒ„');
            const ws2 = [['æœˆä»½','æ”¶å…¥','æ”¯å‡º','é¤˜é¡']];
            for (let m=1; m<=12; m++) {
                const f = (arr) => arr.filter(i=>{const d=new Date(i.date);return d.getFullYear()===currentYear&&d.getMonth()+1===m;}).reduce((s,i)=>s+i.amount,0);
                const it=f(database.incomes), et=f(database.expenses);
                ws2.push([m+'æœˆ', it, et, it-et]);
            }
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws2), 'æœˆåº¦çµ±è¨ˆ');
            XLSX.writeFile(wb, `æ”¶æ”¯ç®¡ç†è¡¨_${currentYear}å¹´.xlsx`);
            showStatus('ğŸ“¥ Excel å·²å°å‡º');
        }

        // =============================================
        // å•Ÿå‹•
        // =============================================
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
